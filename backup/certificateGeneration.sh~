#!/bin/bash

function checkParam(){
	if [ $# != 1 ]; then
		echo "Wrong call to checkParam function"
		exit 2
	fi

	if [ "$1" = ""]; then
		echo "Non initialized parameter detected"
		exit 3
	fi
}

function checkFile(){
	if [ $# != 1 ]; then
		echo "Wrong call to checkFile function"
		exit 4
	fi

	if [ ! -f $1 ]; then
		echo "File not found detected"
		exit 5
	fi
}



PFX_NAME=""
CA_NAME=""
CA_ALIAS=""
ALIAS_NAME=""
SHORT_NAME=""
PASSWORD="ca384ton"

while getopts p:c:f:a:s: opt; do
	case $opt in
		p) PFX_NAME=$OPTARG
		;;
		c) CA_NAME=$OPTARG
		;;
		f) CA_ALIAS=$OPTARG
		;;
		a) ALIAS_NAME=$OPTARG
		;;
		s) SHORT_NAME=$OPTARG
		;;
		\?) echo "Invalid option: -p PFX_FILE -c CA_FILE -f CA_ALIAS -a ALIAS -s SHORT"
			exit 1
		;;
	esac
done

checkParam PFX_NAME
checkParam CA_NAME
checkParam CA_ALIAS
checkParam ALIAS_NAME
checkParam SHORT_NAME

checkFile PFX_NAME
checkFile CA_NAME
checkFile cacerts.jks

openssl pkcs12 -in PFX_NAME -nocerts -out key.pem
openssl pkcs12 -in PFX_NAME -clcerts -nokeys -out cert.pem
openssl rsa -in key.pem -out $SHORT_NAME.key
openssl pkcs12 -export -in cert.pem -inkey $SHORT_NAME.key -out $SHORT_NAME.p12 -name $ALIAS_NAME -CAfile $CA_NAME -caname $CA_ALIAS
keytool -importkeystore -deststorepass $PASSWORD -destkeypass $PASSWORD -destkeystore keystore.jks -srckeystore $SHORT_NAME.p12 -srcstoretype PKCS12 -srcstorepass $PASSWORD -alias $ALIAS_NAME
keytool -import -v -trustcacerts -alias $CA_ALIAS -file $CA_NAME -keystore cacerts.jks

exit 0


