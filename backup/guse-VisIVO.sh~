#!/bin/sh

# unzipping getting files
for files in *.zip; do
	unzip $files
done

# creation of the inputs zip file and deletion of files
zip inputs.zip *.bin input*

# creation of the port mapping file
cat port*.txt > portmapping.txt

# submit
wID=`curl -k -F m=submit -F pass=remotepass -F wfdesc=@workflow.xml -F inputzip=@inputs.zip -F portmapping=@portmapping.txt http://visivo.oact.inaf.it:8080/remote/RemoteServlet`

id=`echo $wID | tr -d '\r'`
st=""

while [ true ]
do
    # status
	clear
    st=`curl -k -F m=info -F ID=$id -F pass=remotepass http://visivo.oact.inaf.it:8080/remote/RemoteServlet`
	stat=`echo $st | tr -d '\r'`
	echo "$stat : $id"

	if [ "$stat" = "finished" ]; then
		break
	fi
	if [ "$stat" = "error" ]; then
		break
	fi
	if [ "$stat" = "not valid data" ]; then
		break
	fi

	sleep 2

done

# get output
if [ "$stat" = "finished" ]; then
    curl -k -F m=download -F ID=$id -F pass=remotepass -o output.zip http://visivo.oact.inaf.it:8080/remote/RemoteServlet
    exit 0
fi

exit 1
